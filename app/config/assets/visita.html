<html>
<!--Menu-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="../../system/libs/bootstrap-3.3.7-dist/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
        <link href="css/odk-survey.css" type="text/css" rel="stylesheet" />
        <link href="css/visita.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="commonDefinitions.js"></script>
        <script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
        <script type="text/javascript" src="../../system/libs/eonasdan/moment.min.js"></script>
        <script type="text/javascript" src="libs/jquery-migrate-3.0.0.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>        
<style>
    #btnVisit {
        border-radius: 20px;
        height: 40px;
        line-height: 10px;
        border: solid 1px black;
        width: 70%;
        text-align: center;
        margin: 0 0 0 15%;
        line-height: 20px;
    }
</style>
        <script type="text/javascript">
        window.dayOffset = 0;
        function getLocalDateString(moment) {
            return translateDay(moment.format('dddd')) + " " + moment.format('DD.MM.YYYY'); 
        }
        function translateDay(strDay) {
            switch (strDay) {
                case 'Monday':
                    return 'Segunda'
                case 'Tuesday':
                    return 'Terça'
                case 'Wednesday':
                    return 'Quarta'
                case 'Thursday':
                    return 'Quinta'
                case 'Friday':
                    return 'Sexta'
                case 'Saturday':
                    return 'Sábado'
                case 'Sunday':
                    return 'Domingo'                                    
                default:
                    return strDay;
            }
        }

        // Displays homescreen
        function display() {
            //console.log('Loading visita v. 0.11');            
            
            window.adateHelper = getAdateHelper();
           
            var sendData = document.createElement("button");
            sendData.setAttribute("id", "button3");
            sendData.innerHTML = "Enviar Dados";
            sendData.onclick = function() {
              odkCommon.doAction(null, "org.opendatakit.services.sync.actions.activities.SyncActivity", {"componentPackage": "org.opendatakit.services", "componentActivity": "org.opendatakit.services.sync.actions.activities.SyncActivity"});
            }
            document.getElementById("wrapper").appendChild(sendData);    


            var selCs = $("#selCs");
            $("#selCs").change(function() {
                var newVal = $(this).val();
                if (!confirm("Tem certeza de mudar centro de saúde para " + newVal + "?")) {
                    //console.log("restoring to: " + $(this).data('val'))
                    $(this).val($(this).data('val')); //set back
                    selectByText($(this).data('val'));
                    return;                           //abort!
                }
                //console.log("Changed to " + newVal);
                
                $(this).data('val', newVal);
                localStorage.setItem("centro", newVal);
                window.dayOffset = 0;
                updateDay();
            });
            $("#theDate").on("click", function() {
                window.dayOffset = 0;
                updateDay();
            })
            $("#prevDay").on("click", function() {
                window.dayOffset -= 1;
                updateDay();
            })
            $("#nextDay").on("click", function() {
                window.dayOffset += 1;
                updateDay();
            })
            $("#btnVisit").on("click", function() {
                odkTables.launchHTML(null, 'config/assets/centro_visit.html');
                return false;
            })

            setTimeout(restoreState, 10);
            setTimeout(updateDay, 100);
        }
        
        function updateDay() {
            window.today = new moment();
            today.add(window.dayOffset, "days");
            $("#theDate").text(getLocalDateString(today));
            loadList();
        }
        function restoreState() {
            // Preload previous selections
            var storedCentro = localStorage.getItem("centro");
            //console.log("Restoring to " + storedCentro);
            if (storedCentro != '') {
                selectByText(storedCentro);
            }
        }
        function selectByText( txt ) {
            $('#selCs option')
            .filter(function() { return $.trim( $(this).text() ) == txt; })
            .attr('selected',true);
        }

        function getRegion(cs) {
            switch (cs) {
                case "bafata":
                case "bambadinca":
                case "ganmamudo":
                    return 'bafata'
                default:
                    return 'gabu'
            }
        }

        function loadList() {
            
            //console.log("Querying database...");
            var successFn = function( result ) {
                //console.log("Found " + result.getCount() + " persons");
                var persons = [];
                for (var row = 0; row < result.getCount(); row++) {
                    var id = result.getData(row,"_id"); // or _row_etag
                    var id_estudo = result.getData(row,"id_estudo");                    
                    
                    var tab_bairro = result.getData(row,"tab_bairro");
                    var zona = result.getData(row, "zona");
                    var cs = result.getData(row, "cs");

                    var date_rastreio = result.getData(row, "date_rastreio");

                    var sexo = result.getData(row, "sexo");
                    var nome =  result.getData(row,"nome");
                    var nome_acomp =  result.getData(row,"nome_acomp");
                    var nome_mae =  result.getData(row,"nome_mae");
                    var nome_pai =  result.getData(row,"nome_pai");

                    var tel_acomp = result.getData(row,"tel_acomp");
                    var tel_mae = result.getData(row,"tel_mae");
                    var tel_pai = result.getData(row,"tel_pai");
                    
                    var DOB_ou_idade = result.getData(row,"DOB_ou_idade");
                    var dn =  result.getData(row,"dn");
                    var ano =  result.getData(row,"ano");
                    var mes =  result.getData(row,"mes");
                    
                    var visits = result.getData(row, "visits");
                    var visitCount = result.getData(row, "visitCount");

                    var doseCount =  result.getData(row,"COUNT_DOSES");

                    var p = {
                        id,
                        id_estudo,
                        tab_bairro,
                        zona,
                        cs,
                        date_rastreio,
                        sexo,
                        nome,
                        nome_acomp,
                        nome_mae,
                        nome_pai,
                        tel_acomp,
                        tel_mae,
                        tel_pai,
                        DOB_ou_idade,
                        dn,
                        ano,
                        mes,
                        visits,
                        visitCount,
                        doseCount,
                    }          

                    if (!isRelevant(p)) continue;
                    
                    persons.push(p);
                }
                populateList(persons);
                return;
            }
            var failureFn = function( errorMsg ) {
                console.error('Failed to get persons from database: ' + errorMsg);
                alert(errorMsg);
            }

            var selCs = $("#selCs").val();
            
            var sql = 'SELECT count(DISTINCT seg._id) as visitCount, count(DISTINCT seg2.id_visita) as COUNT_DOSES, group_concat(DISTINCT seg.id_visita) as visits, ';
            sql = sql + 'inc.tab_bairro, inc.zona, inc.cs, inc.date_rastreio, inc.nome, inc.nome_acomp, inc.nome_mae, inc.nome_pai, inc.tel_acomp, ';
            sql = sql + 'inc.tel_mae, inc.tel_pai, inc.sexo, inc.id_estudo, inc.DOB_ou_idade, inc.ano, inc.mes, inc.dn ';
            sql = sql + 'FROM inclusao inc LEFT JOIN seguimento seg ON inc.id_estudo = seg.id_estudo LEFT JOIN seguimento seg2 ON inc.id_estudo = seg2.id_estudo  AND (seg2.dose_AQ == "1" OR seg2.dose_AQ == "2") AND (seg2.id_visita == "1" OR seg2.id_visita == "2" OR seg2.id_visita == "3") ';
            sql = sql + "WHERE inc.cs = '" + selCs + "' GROUP BY inc._id";

            console.log(sql);
            odkData.arbitraryQuery('inclusao', sql, null, null, null, successFn, failureFn);
        }
        
        function isRelevant(person) {
            var offSet = window.dayOffset;
            var days = adateHelper.ageInDays(person.date_rastreio);
            //console.log(days);
            if ((days+offSet) > 28) return false;
            if ((days+offSet) == 0) return false;
            if ((days+offSet) <= 3) return true;
            if ((days+offSet) % 7 == 0) return true;
            //console.log("NOT RELEVANT");
            person.nome = "NO: " + person.nome;
            return false;
        }

        function getAdjustedDay(p) {            
            // This checks the number of doses this person has been given and adjusts the "day" of the visit to match
            var real_days = adateHelper.ageInDays(p.date_rastreio);
            if (real_days>4) return real_days;
            if (p.doseCount == 0) return 1;
            if (p.doseCount == 1) return 2;
            if (p.doseCount == 2) return 3;
            return real_days;
        }

        function addPersonForm(person) {
            var tableId = "seguimento";
            var formId = "seguimento"; 
            var dispatchStruct = null;
            var screenPath = null;
            var jsonMap = getJsonMap(person);
            odkTables.addRowWithSurvey(dispatchStruct,tableId, formId, screenPath, jsonMap);
            
        }

        function getJsonMap(person) {

            delete person.nome_acomp;
            delete person.tab_bairro;
            delete person.tel_acomp;
            delete person.tel_mae;
            delete person.tel_pai;
            delete person.zona;
            delete person.visitCount;
            delete person.visits;
            delete person.doseCount;
            
            // Add a field with the dose-adjusted day
            person.DoseAdjustedDay =  getAdjustedDay(person);

            console.log("Sending following data:");
            console.log(person);      

            return person;
        }

        function todayAdate() {
            var today = new Date();
            var day = today.getDate();
            var mon = today.getMonth()+1;
            var yea = today.getFullYear();
            var aDate = 'D:' + day + ',M:' + mon + ',Y:' + yea;
            return aDate;
        }
        
        function populateList(listOfPersons) {
            $("#theList tr:not(:first-of-type)").remove(); // clear table except header
            var theList = $("#theList");
            //console.log("Populating list with " + listOfPersons.length + " persons");
            listOfPersons.forEach(person => {
                addPersonDiv(person);
            });
        }
        function addPersonDiv(p) {    
            var btn = "<button class='btn btn-sm'>&gt;</button>";
            if (window.dayOffset < -1 || window.dayOffset > 1) {
                btn =  "";    //show no button for these days.
            }
            var cssClass = '';
            if (p.visitCount != '0') {
                console.log("Viscount = " + p.visitCount);
                console.log("Has visit: " + p.visits);
                if (!p.visits) {
                    alert('Erro: Formulario ka fasido dirritu. Contacta Ivan immediamente!')
                    return;
                }
                var todaysDays = (adateHelper.ageInDays(p.date_rastreio) + window.dayOffset);                
                if (p.visits.split(",").filter(x => x.trim() == todaysDays).length>0) {
                    cssClass = "hasHadVisitToday";
                } else if (todaysDays > 3 && (p.visits.split(",").filter(x => (x.trim() == todaysDays-1 || x.trim() == todaysDays+1)).length>0)) {
                    cssClass = "hasHadVisitADayOff";
                }
            }
            var nome = (p.nome_casa && p.nome_casa.length) ? nome = p.nome + " (" + p.nome_casa + ")" : p.nome;        
            var btnRow = "<tr class='" + cssClass + "'><td>" + getAddress(p) + "</td><td>" + getNames(p) + "</td><td>" + getAgeString(p) + "<br/>" + getPhones(p) + "</td><td>" + btn + "</td></tr>";
            $('#theList tr:last').after(btnRow);
            if (window.dayOffset < -1 || window.dayOffset > 1) {
                // show no button for these days.
            } else {
                $('#theList tr:last').on("click",function() { 
                    addPersonForm(p);
                    return false;
                });
            }
        }
        function getAddress(p) {
            var r = "";
            if (p.tab_bairro) r = r + p.tab_bairro + "<br/>";
            if (p.zona) r = r + p.zona + "<br/>";
            r = r + "ID: " + p.id_estudo + " (dias: " + (adateHelper.ageInDays(p.date_rastreio) + window.dayOffset) + ")";
            return r;
        }
        function getPhones(p) {
            var r = "";
            if (p.tel_mae) r = r + p.tel_mae + " (mãe)<br/>";
            if (p.tel_pai) r = r + p.tel_pai + " (pai)<br/>";
            if (p.tel_acomp) r = r + p.tel_acomp + " (acomp.)<br/>";
            return r;
        }
        function getNames(p) {
            var d = p.nome + (p.sexo == '2' ? ' (F)':' (M)');
            if (p.nome_mae) d = d + "<br/>Mãe: " + p.nome_mae;
            if (p.nome_pai) d = d + "<br/>Pai: " + p.nome_pai;
            if (p.nome_acomp) d = d + "<br/>Acomp.: " + p.nome_acomp;                
            return "<div>" + d + "</div>";
        }

        function getAgeString(person) {
            var theAdate = person.dn;
            if (!theAdate) {
                var res = (person.ano) ? person.ano : "0";
                var mes = person.mes ? person.mes : "0";
                return res + " anos " + mes + " meses";                
            }    
            var months = adateHelper.ageInMonths(theAdate);
            var anosTxt = (months >= 12) ? "" + adateHelper.ageInYears(theAdate) + " anos " : "";
            return anosTxt + (adateHelper.ageInMonths(theAdate) % 12) + " meses";
        }
  
        /* adate helper */
        function getAdateHelper() {return {
            getMoment: function(aDate) {
                if (!aDate || aDate.length<4 || this.yearUnknown(aDate)) {
                    return false;
                }
                aDate = aDate.toUpperCase().replace('D:NS','D:15').replace('M:NS','M:5');
                var d = moment(aDate, '\\D:DD,\\M:MM,\\Y:YYYY');
                if (d.isValid()) {
                    return d;
                }
                return false;
            },
            hasUncertainty: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('NS')>-1;   
            },
            yearUnknown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('Y:NS')>-1;
            },
            monthUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('M:NS')>-1;   
            },
            dayUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('D:NS')>-1;
            },
            ageIn: function(aDate, strUnit) {
                var a = this.getMoment(aDate);
                if (!a) {
                    return -9999;
                }
                return moment().diff(a,strUnit);
            },
            ageInYears: function(aDate) {
                return this.ageIn(aDate, 'years');
            },
            ageInMonths: function(aDate) {
                return this.ageIn(aDate, 'months');
            },
            ageInDays: function(aDate) {
                return this.ageIn(aDate, 'days');
            },
            diffInYears: function(aDateA, aDateB) {
                var a = this.getMoment(aDateA);
                var b = this.getMoment(aDateB);
                if (!a || !b) {
                    return -9999;
                }
                return b.diff(a,'years');
            },
            diffInDays: function(aDateA, aDateB) {
                var a = this.getMoment(aDateA);
                var b = this.getMoment(aDateB);
                if (!a || !b) {
                    return -9999;
                }
                return b.diff(a,'days');
            }            
        }};


        </script>
    </head>

    <body onload="display();">
        <!-- <h1>Avaliação de eficácia de Sulfadoxina-pirimetamina mais Amodiaquina </h1> -->
        <h2>SEGUIMENTOS DE CASOS</h2>
        <form>
            <div class="form-group" style="margin:20px;text-align:center;">
                <label class="form-label" for="selCs">Centro de saúde</label><br/>
                <select id="selCs" class="form-control">
                    <option></option>
                    <option>bafata</option>
                    <option>bambadinca</option>
                    <option>ganmamudo</option>
                    <option>gabu</option>
                    <option>sonaco</option>
                    <option>pitche</option>
                </select>
                <hr/>
                <div style="margin-bottom:10px;">
                    <span id="prevDay">&lt;</span><span id="theDate"></span><span id="nextDay">&gt;</span>
                </div>
            </div><div>
                <table id="theList" class="table">
                    <tr>
                        <th>Tabz</th>
                        <th>Nome</th>
                        <th>Idade</th>
                        <th>&nbsp;</th>
                    </tr>                    
                </table>
            </div>
        </form>
        <br/>
        <div id="wrapper"></div>
        <br/><a id="btnVisit" href="#" class="form-control btn btn-lg btn-primary" >Seguimento de outro dia</a>
    </body>
</html>
