<html>
<!--Menu-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="css/odk-survey.css" type="text/css" rel="stylesheet" />
        <link href="css/visita.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="commonDefinitions.js"></script>
        <script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
        <script type="text/javascript" src="libs/jquery-migrate-3.0.0.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">

        // Displays homescreen
        function display() {

            // /*    Screen new client option that launches new client list view */
            //  var visita = document.createElement("button");
            // visita.setAttribute("id", "button2");
            // visita.innerHTML = "Visitas de hoje";
            // visita.onclick = function() {
            //     odkTables.launchHTML(null, 
            //     'config/assets/selectZona.html');
            // }
            // document.getElementById("wrapper").appendChild(visita);  

            // // Follow up with existing client option that launches
            // // 'femaleClients' table list view
            // var agenda = document.createElement("button");
            // agenda.setAttribute("id", "button2");
            // agenda.innerHTML = "Agenda";
            // agenda.onclick = function() {
            //     odkTables.launchHTML(null, 
            //     'config/assets/selectZona.html');
            // }
            // document.getElementById("wrapper").appendChild(agenda);    

            // Send data option that luanches send finalized forms screen in
            // Collect
            var sendData = document.createElement("button");
            sendData.setAttribute("id", "button3");
            sendData.innerHTML = "Enviar Dados";
            sendData.onclick = function() {
              odkCommon.doAction(null, "org.opendatakit.services.sync.actions.activities.SyncActivity", {"componentPackage": "org.opendatakit.services", "componentActivity": "org.opendatakit.services.sync.actions.activities.SyncActivity"});
            }
            document.getElementById("wrapper").appendChild(sendData);    


            var selCs = $("#selCs");
            selCs.on("change",function() {
                var selVal = $("#selCs").val();
                localStorage.setItem("centro", selVal);
                loadList();
            })
            
            setTimeout(restoreState, 10);
            setTimeout(loadList, 100);
        }
        

        function restoreState() {
            // Preload previous selections
            var storedCentro = localStorage.getItem("centro");
            console.log("Restoring to " + storedCentro);
            if (storedCentro != '') {
                selectByText(storedCentro);
            }
        }
        function selectByText( txt ) {
            $('#selCs option')
            .filter(function() { return $.trim( $(this).text() ) == txt; })
            .attr('selected',true);
        }

        function getRegion(cs) {
            switch (cs) {
                case "bafata":
                case "bambadinca":
                case "cosse":
                    return 'bafata'
                default:
                    return 'gabu'
            }
        }

        function loadList() {
            console.log("Querying database...");
            var successFn = function( result ) {
                console.log("Found " + result.getCount() + " persons");
                var persons = [];
                for (var row = 0; row < result.getCount(); row++) {
                    var id = result.getData(row,"_id"); // or _row_etag
                    // var id_paciente = result.getData(row,"id_estudo");
                    // var id_rastreio = result.getData(row,"id_rastreio");
                    var nome =  result.getData(row,"nome");
                    // var nome_casa =  result.getData(row,"nome_casa");
                    var resTdr =  result.getData(row,"resultado_TDR");
                    var DOB_ou_idade = result.getData(row,"DOB_ou_idade");
                    var dn =  result.getData(row,"dn");
                    var ano =  result.getData(row,"ano");
                    var mes =  result.getData(row,"mes");
                    // var af =  result.getData(row,"AF");
                    // var numRondas = result.getData(row, 'numero_rondas')
                    var p = {
                        id,
                        // id_paciente,
                        nome,
                        resTdr,
                        // sexo,
                         dn,
                         ano,
                         mes,
                        // af,
                        // numRondas
                    }
                    console.log(p);
                    persons.push(p);
                }
                populateList(persons);
                return;
            }
            var failureFn = function( errorMsg ) {
                console.error('Failed to get persons from database: ' + errorMsg);
                alert(errorMsg);
            }

            var sql = 'SELECT _id, nome, DOB_ou_idade, dn, ano, mes, resultado_TDR FROM rastreio WHERE ';
            sql = sql + 'region = "bafata" COLLATE NOCASE AND ';
            sql = sql + 'cs = "bafata" COLLATE NOCASE AND ';
            sql = sql + '(resultado_TDR = 1 OR resultado_TDR = 3) AND ';
            sql = sql + 'date_rastreio = "' + todayAdate() + '" ';
            console.log(sql);
            odkData.arbitraryQuery('rastreio', sql, null, null, null, successFn, failureFn);
        }
        
        function openPersonForm(rowId) {
            var tableId = "rastreio";
            var rowId = rowId;
            var formId = "rastreio"; 
            odkTables.editRowWithSurvey(null, tableId, rowId, formId, null, null);
        }

        function todayAdate() {
            var today = new Date();
            var day = today.getDate();
            var mon = today.getMonth()+1;
            var yea = today.getFullYear();
            var aDate = 'D:' + day + ',M:' + mon + ',Y:' + yea;
            return aDate;
        }
        
        function populateList(listOfPersons) {
            var theList = $("#theList");
            console.log("Populating list with " + listOfPersons.length + " persons");
            listOfPersons.forEach(person => {
                addPersonDiv(person);
            });
        }
        function addPersonDiv(p) {    
            var nome = (p.nome_casa && p.nome_casa.length) ? nome = p.nome + " (" + p.nome_casa + ")" : p.nome;        
            $('#theList tr:last').after("<tr class='tdr" + p.resTdr + "' data-id='" + p._id + "'><td>" + nome + "</td><td>" + getAgeString(p) + "</td><td><input onclick='openPersonForm(\"" + p.id + "\")' type='button' value='&gt;&gt;'></input></td></tr>");
        }
        function getAgeString(person) {
            var theAdate = person.dn;
            if (!theAdate) {
                var res = (person.ano) ? person.ano : "0";
                if (person.mes) res = res + ("." + person.mes);
                return res;
            }    
            return "" + adateHelper.ageInYears(theAdate) + "." + (adateHelper.ageInMonths(theAdate) % 12);
        }
  
        /* adate helper */
        function getAdateHelper() {return {
            getMoment: function(aDate) {
                if (!aDate || aDate.length<4 || this.yearUnknown(aDate)) {
                    return false;
                }
                aDate = aDate.toUpperCase().replace('D:NS','D:15').replace('M:NS','M:5');
                var d = moment(aDate, '\\D:DD,\\M:MM,\\Y:YYYY');
                if (d.isValid()) {
                    return d;
                }
                return false;
            },
            hasUncertainty: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('NS')>-1;   
            },
            yearUnknown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('Y:NS')>-1;
            },
            monthUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('M:NS')>-1;   
            },
            dayUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('D:NS')>-1;
            },
            ageIn: function(aDate, strUnit) {
                var a = this.getMoment(aDate);
                if (!a) {
                    return -9999;
                }
                return moment().diff(a,strUnit);
            },
            ageInYears: function(aDate) {
                return this.ageIn(aDate, 'years');
            },
            ageInMonths: function(aDate) {
                return this.ageIn(aDate, 'months');
            },
            ageInDays: function(aDate) {
                return this.ageIn(aDate, 'days');
            },
            diffInYears: function(aDateA, aDateB) {
                var a = this.getMoment(aDateA);
                var b = this.getMoment(aDateB);
                if (!a || !b) {
                    return -9999;
                }
                return b.diff(a,'years');
            }
        }};

        </script>
    </head>

    <body onload="display();">
        <!-- <h1>Avaliação de eficácia de Sulfadoxina-pirimetamina mais Amodiaquina </h1> -->
        <h2>SEGUIMENTOS DE CASOS</h2>
        <form>
            <div class="form-group" style="margin:20px;text-align:center;">
                <label class="form-label" for="selCs">Centro de saúde</label><br/>
                <select id="selCs" class="form-control">
                    <option></option>
                    <option>bafata</option>
                    <option>bambadinca</option>
                    <option>cosse</option>
                    <option>gabu</option>
                    <option>mafanco</option>
                    <option>pitche</option>
                </select>
                <hr/>
                <table id="theList" class="table">
                    <tr>
                        <th>Nome</th>
                        <th>Idade</th>
                        <th>&nbsp;</th>
                    </tr>                    
                </table>
            </div>
        </form>
        <br/>
        <div id="wrapper"></div>
    </body>
</html>
