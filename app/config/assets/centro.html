<html>
<!--Menu-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="../../system/libs/bootstrap-3.3.7-dist/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
        <link href="css/odk-survey.css" type="text/css" rel="stylesheet" />
        <link href="css/visita.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="commonDefinitions.js"></script>
        <script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
        <script type="text/javascript" src="libs/jquery-migrate-3.0.0.js"></script>
        <script type="text/javascript" src="../../system/libs/eonasdan/moment.min.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">

        // Displays homescreen
        function display() {
            //console.log('Loading centro v. 0.40');
            window.adateHelper = getAdateHelper();
            var btnNew = $("#btnCreateNew");
            var selCs = $("#selCs");
            $("#selCs").change(function() {
                var newVal = $(this).val();
                if (!confirm("Tem certeza de mudar centro de saúde para " + newVal + "?")) {
                    //console.log("restoring to: " + $(this).data('val'))
                    $(this).val($(this).data('val')); //set back
                    selectByText($(this).data('val'));
                    return;                           //abort!
                }
                //console.log("Changed to " + newVal);
                $("#theList tr:not(:first-of-type)").remove(); // clear table except header
                $(this).data('val', newVal);
                localStorage.setItem("centro", newVal);
                loadList();
            });
            // selCs.on("change",function() {
            //     var selVal = $("#selCs").val();
                
            // })

            btnNew.on("click", function() {
                var selVal = $("#selCs").val();
                createNew(selVal);
                return false;
            })

            $("#btnVisit").on("click", function() {
                odkTables.launchHTML(null, 'config/assets/centro_visit.html');
                return false;
            });
            
            setTimeout(restoreState, 10);
            setTimeout(loadList, 100);
        }
        
        function loadList() {            
            //console.log("Querying database...");
            var successFn = function( result ) {
                //console.log("Found " + result.getCount() + " persons");
                var persons = [];
                for (var row = 0; row < result.getCount(); row++) {
                    var id = result.getData(row,"_id"); // or _row_etag
                    var temperatura = result.getData(row,"temperatura");
                    var febre = result.getData(row,"febre");
                    var nome =  result.getData(row,"nome");
                    // var nome_casa =  result.getData(row,"nome_casa");
                    var resTdr =  result.getData(row,"resultado_TDR");
                    var DOB_ou_idade = result.getData(row,"DOB_ou_idade");
                    var dn =  result.getData(row,"dn");
                    var ano =  result.getData(row,"ano");
                    var mes =  result.getData(row,"mes");
                    // var af =  result.getData(row,"AF");
                    // var numRondas = result.getData(row, 'numero_rondas')
                    var p = {
                        id,
                        temperatura,
                        nome,
                        resTdr,
                        febre,
                         dn,
                         ano,
                         mes,
                        // af,
                        // numRondas
                    }
                    //console.log(p);
                    persons.push(p);
                }
                populateList(persons);
                return;
            }
            var failureFn = function( errorMsg ) {
                console.error('Failed to get persons from database: ' + errorMsg);
                alert(errorMsg);
            }

            var selCs = $("#selCs").val();

            var sql = 'SELECT _id, nome, DOB_ou_idade, dn, ano, mes, temperatura, febre, resultado_TDR FROM rastreio WHERE ';
            sql = sql + 'region = "' + getRegion(selCs) + '" COLLATE NOCASE AND ';
            sql = sql + 'cs = "' + selCs + '" COLLATE NOCASE AND ';
            sql = sql + '(resultado_TDR = 1 OR resultado_TDR = 3) AND ';
            sql = sql + 'date_rastreio = "' + todayAdate() + '" ';
            //console.log(sql);

            odkData.arbitraryQuery('rastreio', sql, null, null, null, successFn, failureFn);
        }
        
        function openPersonForm(rowId) {
            var tableId = "rastreio";
            var rowId = rowId;
            var formId = "resultado_tdr"; 
            odkTables.editRowWithSurvey(null, tableId, rowId, formId, null, null);
        }

        function todayAdate() {
            var today = new Date();
            var day = today.getDate();
            var mon = today.getMonth()+1;
            var yea = today.getFullYear();
            var aDate = 'D:' + day + ',M:' + mon + ',Y:' + yea;
            return aDate;
        }
        
        function populateList(listOfPersons) {
            var theList = $("#theList");
            //console.log("Populating list with " + listOfPersons.length + " persons");
            listOfPersons.forEach(person => {
                addPersonDiv(person);
            });
        }
        function addPersonDiv(p) {    
            var nome = (p.nome_casa && p.nome_casa.length) ? nome = p.nome + " (" + p.nome_casa + ")" : p.nome;        
            $('#theList tr:last').after("<tr class='tdr" + p.resTdr + "' data-id='" + p._id + "'><td>" + nome + "</td><td>" + getAgeString(p) + "</td><td><input onclick='openPersonForm(\"" + p.id + "\")' type='button' value='&gt;&gt;'></input></td></tr>");
        }

        function restoreState() {
            // Preload previous selections
            var storedCentro = localStorage.getItem("centro");
            //console.log("Restoring to " + storedCentro);
            if (storedCentro != '') {
                selectByText(storedCentro);
            }
        }
        function selectByText( txt ) {
            $('#selCs option')
            .filter(function() { return $.trim( $(this).text() ) == txt; })
            .attr('selected',true);
        }

        function createNew(centro) {
            var selVal = $("#selCs").val();             
            if (selVal === '') {
                alert('Qual centro?');
                return false;
            }
            var data = {
                cs: centro,
                region: getRegion(centro)
            }
            odkTables.addRowWithSurvey(null,
                    'rastreio',
                    'rastreio',
                    null,
                    data);
            
        }
        function getAgeString(person) {
            var theAdate = person.dn;
            if (!theAdate) {
                var res = (person.ano) ? person.ano : "0";
                if (person.mes) res = res + ("." + person.mes);
                return res;
            }    
            var months = adateHelper.ageInMonths(theAdate);
            var anosTxt = (months >= 12) ? "" + adateHelper.ageInYears(theAdate) + " anos " : "";
            return anosTxt + (adateHelper.ageInMonths(theAdate) % 12) + " meses";
        }

        function getRegion(cs) {
            switch (cs) {
                case "bafata":
                case "bambadinca":
                case "cosse":
                    return 'bafata'
                default:
                    return 'gabu'
            }
        }

        
/* adate helper */
function getAdateHelper() {return {
    getMoment: function(aDate) {
        if (!aDate || aDate.length<4 || this.yearUnknown(aDate)) {
            return false;
        }
        aDate = aDate.toUpperCase().replace('D:NS','D:15').replace('M:NS','M:5');
        var d = moment(aDate, '\\D:DD,\\M:MM,\\Y:YYYY');
        if (d.isValid()) {
            return d;
        }
        return false;
    },
    hasUncertainty: function(aDate) {
        return !aDate || aDate.toUpperCase().indexOf('NS')>-1;   
    },
    yearUnknown: function(aDate) {
        return !aDate || aDate.toUpperCase().indexOf('Y:NS')>-1;
    },
    monthUnkown: function(aDate) {
        return !aDate || aDate.toUpperCase().indexOf('M:NS')>-1;   
    },
    dayUnkown: function(aDate) {
        return !aDate || aDate.toUpperCase().indexOf('D:NS')>-1;
    },
    ageIn: function(aDate, strUnit) {
        var a = this.getMoment(aDate);
        if (!a) {
            return -9999;
        }
        return moment().diff(a,strUnit);
    },
    ageInYears: function(aDate) {
        return this.ageIn(aDate, 'years');
    },
    ageInMonths: function(aDate) {
        return this.ageIn(aDate, 'months');
    },
    ageInDays: function(aDate) {
        return this.ageIn(aDate, 'days');
    },
    diffInYears: function(aDateA, aDateB) {
        var a = this.getMoment(aDateA);
        var b = this.getMoment(aDateB);
        if (!a || !b) {
            return -9999;
        }
        return b.diff(a,'years');
    }
}};
        </script>
    </head>

    <body onload="display();">        
        <form>
            <div class="form-group" style="margin:20px;text-align:center;">
                <label class="form-label" for="selCs">Centro de saúde</label><br/>
                <select id="selCs" class="form-control">
                    <option></option>
                    <option value="bafata">bafata</option>
                    <option value="bambadinca">bambadinca</option>
                    <option value="cosse">cosse</option>
                    <option value="gabu">gabu</option>
                    <option value="mafanco">mafanco</option>
                    <option value="pitche">pitche</option>
                </select>
                <hr/>
            </div>
            <div class="form-group" style="margin:20px;height: 50px;">
                <button id="btnCreateNew" class="form-control btn btn-lg btn-success" style="height:50px;width:50%;margin-right:10%;float:left;">Rastreio</button>
                <a id="btnVisit" href="#" class="form-control btn btn-lg btn-primary" style="height:50px;width:40%;float:right;">Visita</a>
            </div>
            
            <div style="margin:20px;">
                <table id="theList" class="table">
                    <tr>
                        <th>Nome</th>
                        <th>Idade</th>
                        <th>&nbsp;</th>
                    </tr>                    
                </table>
            </div>
        </form>
        <br/>
        <div id="wrapper"></div>
    </body>
</html>
