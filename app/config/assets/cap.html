<html>
<!--Menu-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="../../system/libs/bootstrap-3.3.7-dist/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
        <link href="css/odk-survey.css" type="text/css" rel="stylesheet" />
        <link href="css/cap.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="commonDefinitions.js"></script>
        <script type="text/javascript" src="libs/jquery-3.2.1.js"></script>
        <script type="text/javascript" src="../../system/libs/eonasdan/moment.min.js"></script>
        <script type="text/javascript" src="libs/jquery-migrate-3.0.0.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>        
<style>
    #btnVisit {
        border-radius: 20px;
        height: 40px;
        line-height: 10px;
        border: solid 1px black;
        width: 70%;
        text-align: center;
        margin: 0 0 0 15%;
        line-height: 20px;
    }
</style>
        <script type="text/javascript">
        function getLocalDateString(moment) {
            return translateDay(moment.format('dddd')) + " " + moment.format('DD.MM.YYYY'); 
        }
        function translateDay(strDay) {
            switch (strDay) {
                case 'Monday':
                    return 'Segunda'
                case 'Tuesday':
                    return 'Terça'
                case 'Wednesday':
                    return 'Quarta'
                case 'Thursday':
                    return 'Quinta'
                case 'Friday':
                    return 'Sexta'
                case 'Saturday':
                    return 'Sábado'
                case 'Sunday':
                    return 'Domingo'                                    
                default:
                    return strDay;
            }
        }

        // Displays homescreen
        function display() {
            //console.log('Loading visita v. 0.11');            
            
            window.adateHelper = getAdateHelper();
           
            var sendData = document.createElement("button");
            sendData.setAttribute("id", "button3");
            sendData.innerHTML = "Enviar Dados";
            sendData.onclick = function() {
              odkCommon.doAction(null, "org.opendatakit.services.sync.actions.activities.SyncActivity", {"componentPackage": "org.opendatakit.services", "componentActivity": "org.opendatakit.services.sync.actions.activities.SyncActivity"});
            }
            document.getElementById("wrapper").appendChild(sendData);    


            var selCs = $("#selCs");
            $("#selCs").change(function() {
                var newVal = $(this).val();
                if (!confirm("Tem certeza de mudar centro de saúde para " + newVal + "?")) {
                    //console.log("restoring to: " + $(this).data('val'))
                    $(this).val($(this).data('val')); //set back
                    selectByText($(this).data('val'));
                    return;                           //abort!
                }
                //console.log("Changed to " + newVal);
                
                $(this).data('val', newVal);
                localStorage.setItem("centro", newVal);
                updateDay();
            });

            setTimeout(restoreState, 10);
          
        }
        
        function restoreState() {
            // Preload previous selections
            var storedCentro = localStorage.getItem("centro");
            //console.log("Restoring to " + storedCentro);
            if (storedCentro != '') {
                selectByText(storedCentro);
            }
        }
        function selectByText( txt ) {
            $('#selCs option')
            .filter(function() { return $.trim( $(this).text() ) == txt; })
            .attr('selected',true);
        }

        function getRegion(cs) {
            switch (cs) {
                case "bafata":
                case "bambadinca":
                case "cosse":
                    return 'bafata'
                default:
                    return 'gabu'
            }
        }

        function loadList() {
            
            //console.log("Querying database...");
            var successFn = function( result ) {
                //console.log("Found " + result.getCount() + " persons");
                var persons = [];
                for (var row = 0; row < result.getCount(); row++) {
                    var id = result.getData(row,"_id"); // or _row_etag
                    var id_estudo = result.getData(row,"id_estudo");                    
                    
                    var tab_bairro = result.getData(row,"tab_bairro");
                    var zona = result.getData(row, "zona");
                    var cs = result.getData(row, "cs");

                    var date_rastreio = result.getData(row, "date_rastreio");

                    var sexo = result.getData(row, "sexo");
                    var nome =  result.getData(row,"nome");
                    var nome_acomp =  result.getData(row,"nome_acomp");
                    var nome_mae =  result.getData(row,"nome_mae");
                    var nome_pai =  result.getData(row,"nome_pai");

                    var tel_acomp = result.getData(row,"tel_acomp");
                    var tel_mae = result.getData(row,"tel_mae");
                    var tel_pai = result.getData(row,"tel_pai");
                    
                    var DOB_ou_idade = result.getData(row,"DOB_ou_idade");
                    var dn =  result.getData(row,"dn");
                    var ano =  result.getData(row,"ano");
                    var mes =  result.getData(row,"mes");

                    var p = {
                        id,
                        id_estudo,
                        tab_bairro,
                        zona,
                        cs,
                        date_rastreio,
                        sexo,
                        nome,
                        nome_acomp,
                        nome_mae,
                        nome_pai,
                        tel_acomp,
                        tel_mae,
                        tel_pai,
                        DOB_ou_idade,
                        dn,
                        ano,
                        mes,                        
                    }          

                    persons.push(p);
                }
                populateList(persons);
                return;
            }
            var failureFn = function( errorMsg ) {
                console.error('Failed to get persons from database: ' + errorMsg);
                alert(errorMsg);
            }

            var selCs = $("#selCs").val();
            var sql = 'SELECT inc.tab_bairro, inc.zona, inc.cs, inc.date_rastreio, inc.nome, inc.nome_acomp, inc.nome_mae, inc.nome_pai, inc.tel_acomp, inc.tel_mae, inc.tel_pai, inc.sexo, inc.id_estudo, inc.DOB_ou_idade, inc.ano, inc.mes, inc.dn FROM inclusao inc WHERE inc.cs = "' + selCs + '" GROUP BY inc._id';

         
            console.log(sql);
            odkData.arbitraryQuery('inclusao', sql, null, null, null, successFn, failureFn);
        }
        
        function addPersonForm(person) {
            var tableId = "cap";
            var formId = "cap"; 
            var dispatchStruct = null;
            var screenPath = null;
            var jsonMap = getJsonMap(person);
            odkTables.addRowWithSurvey(dispatchStruct,tableId, formId, screenPath, jsonMap);
            
        }

        function getJsonMap(person) {
            var data = {
                cs: person.cs,
                region: getRegion(person.cs)
            };
            
            console.log("Sending following data:");
            console.log(data);      

            return data;
        }

        function todayAdate() {
            var today = new Date();
            var day = today.getDate();
            var mon = today.getMonth()+1;
            var yea = today.getFullYear();
            var aDate = 'D:' + day + ',M:' + mon + ',Y:' + yea;
            return aDate;
        }
        
        function populateList(listOfPersons) {
            $("#theList tr:not(:first-of-type)").remove(); // clear table except header
            var theList = $("#theList");
            //console.log("Populating list with " + listOfPersons.length + " persons");
            listOfPersons.forEach(person => {
                addPersonDiv(person);
            });
        }
        function addPersonDiv(p) {    
            var btn = "<button class='btn btn-sm'>&gt;</button>";
            var nome = (p.nome_casa && p.nome_casa.length) ? nome = p.nome + " (" + p.nome_casa + ")" : p.nome;        
            var btnRow = "<tr class='" + cssClass + "'><td>" + getAddress(p) + "</td><td>" + getNames(p) + "</td><td>" + getAgeString(p) + "<br/>" + getPhones(p) + "</td><td>" + btn + "</td></tr>";
            $('#theList tr:last').after(btnRow);
            $('#theList tr:last').on("click",function() { 
                addPersonForm(p);
                return false;
            });
        }
        
        function getAddress(p) {
            var r = "";
            if (p.tab_bairro) r = r + p.tab_bairro + "<br/>";
            if (p.zona) r = r + p.zona + "<br/>";
            r = r + "ID: " + p.id_estudo + " (dias: " + adateHelper.ageInDays(p.date_rastreio) + ")";
            return r;
        }
        function getPhones(p) {
            var r = "";
            if (p.tel_mae) r = r + p.tel_mae + " (mãe)<br/>";
            if (p.tel_pai) r = r + p.tel_pai + " (pai)<br/>";
            if (p.tel_acomp) r = r + p.tel_acomp + " (acomp.)<br/>";
            return r;
        }
        function getNames(p) {
            var d = p.nome + (p.sexo == '2' ? ' (F)':' (M)');
            if (p.nome_mae) d = d + "<br/>Mãe: " + p.nome_mae;
            if (p.nome_pai) d = d + "<br/>Pai: " + p.nome_pai;
            if (p.nome_acomp) d = d + "<br/>Acomp.: " + p.nome_acomp;                
            return "<div>" + d + "</div>";
        }

        function getAgeString(person) {
            var theAdate = person.dn;
            if (!theAdate) {
                var res = (person.ano) ? person.ano : "0";
                var mes = person.mes ? person.mes : "0";
                return res + " anos " + mes + " meses";                
            }    
            var months = adateHelper.ageInMonths(theAdate);
            var anosTxt = (months >= 12) ? "" + adateHelper.ageInYears(theAdate) + " anos " : "";
            return anosTxt + (adateHelper.ageInMonths(theAdate) % 12) + " meses";
        }
  
        /* adate helper */
        function getAdateHelper() {return {
            getMoment: function(aDate) {
                if (!aDate || aDate.length<4 || this.yearUnknown(aDate)) {
                    return false;
                }
                aDate = aDate.toUpperCase().replace('D:NS','D:15').replace('M:NS','M:5');
                var d = moment(aDate, '\\D:DD,\\M:MM,\\Y:YYYY');
                if (d.isValid()) {
                    return d;
                }
                return false;
            },
            hasUncertainty: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('NS')>-1;   
            },
            yearUnknown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('Y:NS')>-1;
            },
            monthUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('M:NS')>-1;   
            },
            dayUnkown: function(aDate) {
                return !aDate || aDate.toUpperCase().indexOf('D:NS')>-1;
            },
            ageIn: function(aDate, strUnit) {
                var a = this.getMoment(aDate);
                if (!a) {
                    return -9999;
                }
                return moment().diff(a,strUnit);
            },
            ageInYears: function(aDate) {
                return this.ageIn(aDate, 'years');
            },
            ageInMonths: function(aDate) {
                return this.ageIn(aDate, 'months');
            },
            ageInDays: function(aDate) {
                return this.ageIn(aDate, 'days');
            },
            diffInYears: function(aDateA, aDateB) {
                var a = this.getMoment(aDateA);
                var b = this.getMoment(aDateB);
                if (!a || !b) {
                    return -9999;
                }
                return b.diff(a,'years');
            },
            diffInDays: function(aDateA, aDateB) {
                var a = this.getMoment(aDateA);
                var b = this.getMoment(aDateB);
                if (!a || !b) {
                    return -9999;
                }
                return b.diff(a,'days');
            }            
        }};


        </script>
    </head>

    <body onload="display();">
        <!-- <h1>Avaliação de eficácia de Sulfadoxina-pirimetamina mais Amodiaquina </h1> -->
        <h2>CAP</h2>
        <form>
            <div class="form-group" style="margin:20px;text-align:center;">
                <label class="form-label" for="selCs">Centro de saúde</label><br/>
                <select id="selCs" class="form-control">
                    <option></option>
                    <option>bafata</option>
                    <option>bambadinca</option>
                    <option>cosse</option>
                    <option>gabu</option>
                    <option>mafanco</option>
                    <option>pitche</option>
                </select>
                
            </div><div>
                <table id="theList" class="table">
                    <tr>
                        <th>Tabz</th>
                        <th>Nome</th>
                        <th>Idade</th>
                        <th>&nbsp;</th>
                    </tr>                    
                </table>
            </div>
        </form>
        <br/>
        <div id="wrapper"></div>
    </body>
</html>
